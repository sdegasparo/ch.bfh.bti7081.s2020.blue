language: java
dist: bionic

install: true
os: linux

if: tag is blank

notifications:
  email: false

services:
  - postgresql

addons:
  apt:
    packages:
      - postgresql-12
      - postgresql-client-12
  sonarcloud:
    organization: "zeroplexer"
    token:
      secure: "ED8xNO5yiDiWUrRf4qd4KFOEPqbj3njGrlkXq4jfeaUVJ5eZaRYsvW1ITmV0x5Z8gnh1pRA1WlIYWGAisOIzOY/EWYB1vKIMqajyXBb3wWi7T1F3JiRwVB5h8aKAuY/mHP/H/66biJoNySC5dSMjvo4WB1w0vADC7l95f9PYPILtmnPdYFLUn7jQasFkpOPI9D8uAHC3L0K74JZ34lxBn7teyM08iflIm
gD9F5X/eb/9cHMflBhLvLJUGHq5zR4Mx2fApITHR3nfbehYe4uesB6HKv1QHJYpjmT91IdtBHWoYR6+IqCCxHdAavRjx8cee2JnfRkvwLNqIzwLOF+isUS30X7KpHJbPjrSpix7Pucvk30gwCj9nn9f7945FxcWIVeC1eXwCP4IwOiypcUZCTqpTaiTKj2h5781rQv9fvwb1iczoHjNrse+x5vgivRHGBbaNpVGcmdRh
BO0mEN2oWXbP5uiDmMeqEQ7Qld8LDuEO8iHf+npV7Od/YiPAezhXbVA5y1mlKhmUuglaSZKcBG8DuSM9At2b1z6Qi8KqGiutKhTJB8uVN11jnjYhmIhCBi/ybCHD9UC/ZB+cNVH/BsN2hOzXzujutJk8z0ePYLUbA31TFJwMA+Bbaud7jqGlWMkSHNTzg16dS7rnck41VW75AniOvBT16jFYYlc/wU="
  postgresql: '12'

before_install:
  - sudo pg_dropcluster --stop 12 main
  - sudo pg_upgradecluster 11 main
  - sudo pg_ctlcluster 12 main restart
  - sudo pg_dropcluster 11 main

env:
  global:
    - PGUSER=postgres
    - PGPORT=5432

jobs:
  include:
    # OracleJDK - Java 11 (lts, main build)
    - env: MAIN_BUILD='true'
      jdk: openjdk11
    # OpenJDK - Java 13 (latest)
    - env: MAIN_BUILD='false'
      jdk: openjdk13

before_script:
  - psql -c "CREATE DATABASE social_anxiety_integration;" -U postgres
  - psql -c "CREATE USER social_anxiety WITH PASSWORD 'social_anxiety_password';" -U postgres

script:
  - if [[ "${MAIN_BUILD}" != "" && "${MAIN_BUILD}" == "true" ]]; then export MAVEN_COMMAND="verify"; else export MAVEN_COMMAND="verify"; fi
  - mvn -f source/pom.xml versions:set -DnewVersion=${TRAVIS_BUILD_NUMBER}
  - mvn -f source/pom.xml org.jacoco:jacoco-maven-plugin:prepare-agent ${MAVEN_COMMAND} sonar:sonar

cache:
  directories:
    - $HOME/.m2
    - $HOME/.sonar/cache
